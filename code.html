<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TOUR EATS</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&family=Helvetica+Neue&display=swap" rel="stylesheet">
    <style>
        /* --- é€šç”¨èˆ‡åŸºç¤æ¨£å¼ --- */
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #f0c419; /* é‡‘é»ƒè‰² */
            --primary-gradient: linear-gradient(135deg, #c5a22d, #f0c419, #ffec8a);
            --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0;
            --font-main: 'Noto Sans TC', 'Helvetica Neue', sans-serif;
            --border-radius: 12px;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.7;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            margin: 0;
            padding: 30px 20px;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .container {
            text-align: center;
            background-color: var(--surface-color);
            padding: 40px 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 800px;
            width: 100%;
            border: 1px solid rgba(255,255,255,0.1);
        }
        h1 {
            font-size: 2.8em;
            font-weight: 700;
            margin-top: 0;
            margin-bottom: 20px;
            letter-spacing: 1px;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-fill-color: transparent;
        }
        h3, h4 {
            color: var(--primary-color);
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.5em;
            font-weight: 500;
            border-bottom: 2px solid rgba(255,255,255,0.1);
            padding-bottom: 10px;
        }
        p#result {
            color: var(--text-color);
            font-size: 1.1em;
            min-height: 25px;
            margin-bottom: 25px;
        }
        .divider {
            border-top: 1px solid rgba(255,255,255,0.1);
            margin: 30px 0;
        }

        /* --- é ç±¤å°è¦½åˆ— (å›ºå®šé ‚éƒ¨) --- */
        .tab-nav {
            display: flex;
            margin-bottom: 30px;
            position: -webkit-sticky;
            position: sticky;
            top: 0;
            z-index: 1000;
            background-color: var(--surface-color);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            margin-left: -30px; 
            margin-right: -30px;
            padding-left: 30px;
            padding-right: 30px;
        }
        .tab-btn {
            flex: 1;
            padding: 15px 10px;
            background: none;
            border: none;
            color: var(--text-secondary-color);
            font-size: 1.1em;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.3s ease, border-bottom 0.3s ease;
            border-bottom: 3px solid transparent;
            margin-bottom: -2px;
        }
        .tab-btn:hover { color: var(--text-color); }
        .tab-btn.active { color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- è¼¸å…¥èˆ‡æŒ‰éˆ• --- */
        input[type="file"] { display: block; margin: 20px auto; width: 100%; max-width: 400px; padding: 10px; color: var(--text-color); background-color: var(--surface-color); border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; font-size: 1em; }
        input[type="file"]::file-selector-button { background: var(--primary-gradient); color: #121212; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; transition: transform 0.2s ease; margin-right: 15px; }
        input[type="file"]::file-selector-button:hover { transform: translateY(-1px); }
        #image-preview-container { margin-top: 20px; text-align: center; background-color: rgba(0,0,0,0.2); border-radius: 8px; padding: 10px;}
        #image-preview { max-width: 100%; max-height: 300px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 2px 8px rgba(0,0,0,0.1); display: block; margin: 0 auto;}
        #preferences-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; margin-top: 15px;}
        .pref-item label { display: flex; align-items: center; cursor: pointer; color: var(--text-color); font-size: 1em; background-color: rgba(255,255,255,0.08); padding: 10px 15px; border-radius: 8px; transition: background-color 0.2s ease; }
        .pref-item label:hover { background-color: rgba(255,255,255,0.15); }
        .pref-item input[type="checkbox"] { margin-right: 10px; appearance: none; -webkit-appearance: none; width: 20px; height: 20px; border: 2px solid var(--primary-color); border-radius: 4px; position: relative; cursor: pointer; outline: none; transition: background-color 0.2s ease, border-color 0.2s ease; }
        .pref-item input[type="checkbox"]:checked { background-color: var(--primary-color); border-color: var(--primary-color); }
        .pref-item input[type="checkbox"]:checked::after { content: 'âœ“'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #121212; font-size: 14px; font-weight: bold; }
        #custom-pref-container { display: flex; gap: 10px; margin-top: 15px; }
        #custom-pref-input { flex-grow: 1; padding: 12px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 1em; background-color: rgba(0,0,0,0.2); color: var(--text-color); }
        #custom-pref-input::placeholder { color: var(--text-secondary-color); }
        #add-pref-btn { background: linear-gradient(90deg, #2ecc71, #27ae60); color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; flex-shrink: 0; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3); }
        #add-pref-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(46, 204, 113, 0.4); }
        #custom-prefs-display { margin-top: 10px; display: flex; flex-wrap: wrap; gap: 8px; }
        .custom-tag { background-color: rgba(255,255,255,0.1); color: var(--text-color); padding: 6px 12px; border-radius: 15px; font-size: 0.9em; display: inline-flex; align-items: center; border: 1px solid rgba(255,255,255,0.15); }
        .delete-tag-btn { background: none; border: none; color: var(--text-secondary-color); margin-left: 8px; cursor: pointer; font-weight: bold; font-size: 0.9em; line-height: 1; transition: color 0.2s ease; }
        .delete-tag-btn:hover { color: var(--primary-color); }
        #language-selector { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.2); background-color: rgba(0,0,0,0.2); color: var(--text-color); margin-top: 15px; font-size: 1em; appearance: none; -webkit-appearance: none; background-image: url('data:image/svg+xml;utf8,<svg fill="%23e0e0e0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>'); background-repeat: no-repeat; background-position: right 10px center; background-size: 20px; }
        #language-selector option { background-color: var(--surface-color); color: var(--text-color); }
        .process-button { background: var(--primary-gradient); color: #121212; border: none; padding: 15px 25px; border-radius: 50px; font-size: 1.2em; font-weight: bold; cursor: pointer; transition: all 0.3s ease; display: block; width: 100%; margin-top: 40px; box-shadow: 0 4px 10px rgba(240, 196, 25, 0.3); }
        .process-button:hover { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(240, 196, 25, 0.4); }
        .process-button:disabled { background: #888; cursor: not-allowed; transform: none; box-shadow: none; color: #555; }

        /* --- AI åˆ†æçµæœ --- */
        .result-section { background-color: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 15px 20px; margin-top: 20px; text-align: left; }
        .result-section h4 { margin-top: 0; color: var(--primary-color); font-size: 1.2em; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; }
        .result-section ul { list-style-type: none; padding: 0; margin: 0; }
        .result-section li { padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; flex-direction: column; }
        .result-section li:last-child { border-bottom: none; }
        .dish-translation { display: flex; flex-direction: column; flex-grow: 1; }
        .original-text { font-size: 0.8em; color: var(--text-secondary-color); margin-top: 4px; }
        .original-text.filtered-out { color: #888 !important; }
        .highlight { font-weight: 500; color: #fff;}
        .filtered-out { color: #aaa; text-decoration: line-through; }
        .reason-tag { display: inline-block; margin-top: 8px; background-color: rgba(255, 193, 7, 0.15); color: var(--primary-color); font-size: 0.75em; font-weight: 500; padding: 4px 10px; border-radius: 10px; white-space: normal; border: 1px solid rgba(255, 193, 7, 0.25); }
        #status-container { display: flex; justify-content: center; align-items: center; flex-direction: column; padding: 20px; }
        .loader { border: 6px solid rgba(255,255,255,0.1); border-radius: 50%; border-top: 6px solid var(--primary-color); width: 50px; height: 50px; animation: spin 1.5s linear infinite; margin-bottom: 15px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .status-text { font-style: italic; color: var(--text-secondary-color); }

        /* --- è½‰ç›¤ --- */
        .spinner-section { display: none; margin-top: 40px; padding-top: 30px; border-top: 1px solid rgba(255,255,255,0.1); }
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 0 auto 30px; }
        canvas#wheel { width: 100%; height: 100%; transition: transform 5s cubic-bezier(0.1, 0.7, 0.3, 1); border-radius: 50%; background-color: #333; cursor: pointer; }
        .pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid var(--primary-color); z-index: 10; }
        .spin-button { background: var(--primary-gradient); color: #121212; border: none; padding: 15px 45px; font-size: 1.2em; font-weight: bold; border-radius: 50px; cursor: pointer; transition: all 0.3s; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(240, 196, 25, 0.3); }
        .spin-button:hover:not(:disabled) { transform: translateY(-3px); box-shadow: 0 6px 15px rgba(240, 196, 25, 0.4); }
        .spin-button:disabled { background: #888; cursor: not-allowed; transform: none; box-shadow: none; color: #555;}
        .action-btn-group { display: flex; justify-content: center; gap: 15px; margin-top: 20px; align-items: center;}
        .action-btn { background-color: var(--primary-color); color: #121212; border: none; padding: 12px 25px; font-size: 1em; font-weight: bold; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; }
        .action-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }

        /* --- ç¾é£Ÿæ—¥èªŒ --- */
        #history-list { list-style: none; padding: 0; margin: 0; display: grid; gap: 20px; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); }
        #history-list li { background-color: rgba(0,0,0,0.2); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); overflow: hidden; text-align: left; border: 1px solid rgba(255,255,255,0.1); position: relative; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        #history-list li:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.15); }
        .history-img { width: 100%; height: 180px; object-fit: cover; background-color: rgba(255,255,255,0.05); display: flex; justify-content: center; align-items: center; color: var(--text-secondary-color); font-size: 0.9em; pointer-events: none; }
        .history-img img { width: 100%; height: 100%; object-fit: cover; }
        .history-details { padding: 15px; pointer-events: none; }
        .history-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .history-header h4 { margin: 0; color: #fff; font-size: 1.1em; border-bottom: none; padding-bottom: 0;}
        .history-actions { position: absolute; top: 10px; right: 10px; pointer-events: all; } /* è®“å‹•ä½œæŒ‰éˆ•å¯ä»¥é»æ“Š */
        .history-actions button { background: rgba(0,0,0,0.5); border: none; font-size: 1.1em; cursor: pointer; padding: 8px; border-radius: 50%; line-height: 1; opacity: 0.8; transition: opacity 0.2s, color 0.2s, background-color 0.2s; color: var(--text-color); }
        .history-actions button:hover { opacity: 1; background: #e74c3c; color: #fff; }
        .history-details p.truncated-note { margin: 0 0 12px 0; font-size: 0.95em; color: var(--text-color); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        .timestamp { font-size: 0.8em; color: var(--text-secondary-color); text-align: right; display: block; }
        .clear-history-container { margin-top: 25px; text-align: center; }
        #clear-history-btn { background-color: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; transition: background-color 0.3s; box-shadow: 0 4px 10px rgba(231, 76, 60, 0.3); }
        #clear-history-btn:hover { background-color: #c0392b; transform: translateY(-2px); box-shadow: 0 6px 15px rgba(231, 76, 60, 0.4); }

        /* --- å½ˆå‡ºè¦–çª— (é€šç”¨) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); z-index: 2000; display: none; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal { background: var(--surface-color); padding: 25px; border-radius: var(--border-radius); width: 100%; max-width: 450px; box-shadow: 0 5px 20px rgba(0,0,0,0.3); text-align: left; border: 1px solid rgba(255,255,255,0.1); }
        .modal h2 { margin-top: 0; margin-bottom: 20px; color: var(--primary-color); font-size: 1.5em; text-align: center; -webkit-background-clip: unset; -webkit-text-fill-color: unset; }
        .modal-image-preview { width: 100%; height: 180px; background: rgba(255,255,255,0.05); border-radius: 8px; margin-bottom: 15px; display: flex; justify-content: center; align-items: center; overflow: hidden; border: 1px dashed rgba(255,255,255,0.1); }
        .modal-image-preview img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .modal-image-preview span { color: var(--text-secondary-color); }
        .modal .upload-btn-label { display: block; width: 100%; text-align: center; padding: 10px; background: #3498db; color: #fff; border-radius: 8px; cursor: pointer; margin-bottom: 15px; transition: background 0.3s; box-sizing: border-box; font-weight: bold; }
        .modal .upload-btn-label:hover { background: #2980b9; }
        .modal-actions { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px; }
        .modal-actions button { flex-grow: 1; padding: 12px; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer; transition: all 0.3s; }
        
        /* "ç·¨è¼¯"å½ˆå‡ºè¦–çª—ç‰¹å®šæ¨£å¼ */
        #log-modal-overlay #modal-image-input { display: none; }
        #log-modal-overlay textarea { width: 100%; min-height: 80px; padding: 10px; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; font-size: 1em; resize: vertical; box-sizing: border-box; background-color: rgba(0,0,0,0.2); color: var(--text-color); }
        #log-modal-overlay textarea::placeholder { color: var(--text-secondary-color); }
        #modal-save-btn { background: #2ecc71; color: white; }
        #modal-save-btn:hover { background: #27ae60; }
        #modal-cancel-btn { background: #bdc3c7; color: #121212;}
        #modal-cancel-btn:hover { background: #95a5a6; }

        /* "æª¢è¦–"å½ˆå‡ºè¦–çª—ç‰¹å®šæ¨£å¼ */
        #history-view-text { background-color: rgba(0,0,0,0.2); padding: 15px; border-radius: 8px; min-height: 80px; white-space: pre-wrap; word-break: break-word; color: var(--text-color); margin-bottom: 20px; }
        #history-view-edit-btn { background: var(--primary-gradient); color: #121212; }
        #history-view-edit-btn:hover { transform: translateY(-2px); }
        #history-view-close-btn { background: #bdc3c7; color: #121212; }
        #history-view-close-btn:hover { background: #95a5a6; }
        
        /* --- ç…™ç«èˆ‡é€šçŸ¥ --- */
        #fireworks-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 3001; pointer-events: none; }
        #toast-notification { position: fixed; bottom: 20px; right: 20px; z-index: 3000; background-color: #2a2a2a; border: 1px solid rgba(255,255,255,0.15); border-radius: var(--border-radius); box-shadow: 0 10px 30px rgba(0,0,0,0.6); overflow: hidden; transform: translateX(calc(100% + 20px)); transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1); max-width: 350px; pointer-events: none; }
        #toast-notification.show { transform: translateX(0); pointer-events: all; }
        .toast-content { padding: 20px; text-align: center; position: relative; }
        #toast-message { display: block; font-size: 1.1em; font-weight: 500; margin-bottom: 15px; color: #fff; }
        .toast-actions { display: flex; gap: 10px; justify-content: center; }
        .toast-actions button { padding: 8px 18px; border-radius: 8px; font-size: 0.9em; font-weight: bold; cursor: pointer; border: none; transition: all 0.2s ease; }
        #toast-edit-btn { background-color: var(--primary-color); color: #121212; }
        #toast-edit-btn:hover { background-color: #d4ac17; }
        #toast-confirm-btn { background-color: rgba(255,255,255,0.15); color: var(--text-color); }
        #toast-confirm-btn:hover { background-color: rgba(255,255,255,0.25); }

        /* --- éŸ¿æ‡‰å¼èª¿æ•´ --- */
        @media (max-width: 768px) {
            body { padding: 20px 15px; }
            .container { padding: 30px 20px; }
            h1 { font-size: 2.2em; }
            h3, h4 { font-size: 1.3em; }
            .wheel-container { width: 250px; height: 250px; }
            .spin-button { padding: 12px 30px; font-size: 1em; }
            .action-btn { padding: 10px 20px; font-size: 0.9em; }
            #history-list { grid-template-columns: 1fr; }
            #preferences-grid { grid-template-columns: 1fr; }
            .tab-nav { margin-left: -20px; margin-right: -20px; padding-left: 20px; padding-right: 20px; }
        }
    </style>
</head>
<body>
    <canvas id="fireworks-canvas"></canvas>

    <div class="container">
        <h1>TOUR EATS</h1>
        
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="analysis">æ™ºæ…§åˆ†æ & è½‰ç›¤</button>
            <button class="tab-btn" data-tab="history">ç¾é£Ÿæ—¥èªŒ</button>
        </div>

        <div class="tab-content-wrapper">

            <div class="tab-content active" id="tab-content-analysis">
                <p id="result">ä¸Šå‚³èœå–®åœ–ç‰‡ï¼Œè¨­å®šåå¥½ï¼Œè®“ AI å¹«æ‚¨åˆ†æï¼</p>
                <div class="main-content-section" id="initial-setup-section">
                    <h3>1. ä¸Šå‚³èœå–®åœ–ç‰‡</h3>
                    <input type="file" id="menu-image" accept="image/*">
                    <div id="image-preview-container"><img id="image-preview" src="https://i.imgur.com/wSAa8a1.jpeg" alt="èœå–®é è¦½"></div>
                    <div class="divider"></div>
                    <h3>2. è¨­å®šæ‚¨çš„é£²é£Ÿåå¥½</h3>
                    <div id="preferences-grid">
                        <div class="pref-item"><label><input type="checkbox" id="pref-vegetarian"> æˆ‘æ˜¯ç´ é£Ÿè€…</label></div>
                        <div class="pref-item"><label><input type="checkbox" id="pref-no-pork"> ä¸è¦è±¬è‚‰</label></div>
                        <div class="pref-item"><label><input type="checkbox" id="pref-no-nuts"> ä¸è¦å …æœ/èŠ±ç”Ÿ</label></div>
                        <div class="pref-item"><label><input type="checkbox" id="pref-no-alcohol"> ä¸è¦é…’ç²¾</label></div>
                        <div class="pref-item"><label><input type="checkbox" id="pref-no-spicy"> ä¸åƒè¾£</label></div>
                    </div>
                    <h4 style="margin-top:20px; margin-bottom: 5px; text-align: center;">è‡ªè¨‚ä¸æƒ³åƒçš„é£Ÿæ (ä¾‹å¦‚: é›è‚‰)</h4>
                    <div id="custom-pref-container">
                        <input type="text" id="custom-pref-input" placeholder="è¼¸å…¥é—œéµå­—...">
                        <button id="add-pref-btn">æ–°å¢</button>
                    </div>
                    <div id="custom-prefs-display"></div>
                    <div class="divider"></div>
                    <h3>3. é¸æ“‡ç¿»è­¯èªè¨€</h3>
                    <select id="language-selector">
                        <option value="zh-TW">ç¹é«”ä¸­æ–‡ (Traditional Chinese)</option>
                        <option value="zh-CN">ç°¡é«”ä¸­æ–‡ (Simplified Chinese)</option>
                        <option value="en">English</option>
                        <option value="ja">æ—¥æœ¬èª (Japanese)</option>
                        <option value="ko">í•œêµ­ì–´ (Korean)</option>
                    </select>
                    <button class="process-button" id="process-btn">é–‹å§‹åˆ†æèœå–®</button>
                </div>
                <div id="analysis-results-section" style="display: none;">
                    <div class="divider"></div>
                    <h3>4. AI åˆ†æçµæœ</h3>
                    <div id="results"></div>
                </div>
                <div class="spinner-section" id="spinner-section">
                    <div class="divider"></div>
                    <h3>5. ç¾é£Ÿé¸æ“‡è½‰ç›¤</h3>
                    <p id="spinner-result-text">é»æ“ŠæŒ‰éˆ•ï¼Œæ±ºå®šä½ çš„ä¸‹ä¸€é¤ï¼</p>
                    <div class="wheel-container">
                        <div class="pointer"></div>
                        <canvas id="wheel" width="350" height="350"></canvas>
                    </div>
                    <div class="action-btn-group" id="spinner-controls">
                        <button class="spin-button" id="spin-btn">é–‹å§‹æ—‹è½‰ï¼</button>
                        <div id="spin-actions" style="display: none;">
                           <button class="action-btn" id="keep-btn">å°±æ˜¯å®ƒäº†ï¼</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="tab-content-history">
                <div class="history-section">
                    <h3>ç¾é£Ÿæ—¥èªŒ</h3>
                    <div id="history-list"></div>
                    <div class="clear-history-container"><button id="clear-history-btn">æ¸…é™¤å…¨éƒ¨ç´€éŒ„</button></div>
                </div>
            </div>
        </div>
    </div>

    <!-- è¨˜éŒ„/ç·¨è¼¯å½ˆå‡ºè¦–çª— (Modal) HTML -->
    <div class="modal-overlay" id="log-modal-overlay">
        <div class="modal">
            <h2 id="modal-title"></h2>
            <div class="modal-image-preview" id="modal-image-preview"><span>åœ–ç‰‡é è¦½å€</span></div>
            <label for="modal-image-input" class="upload-btn-label">æ›´æ›ç…§ç‰‡</label>
            <input type="file" id="modal-image-input" accept="image/*">
            <textarea id="modal-text-input" placeholder="åœ¨é€™è£¡å¯«ä¸‹ä½ çš„ç”¨é¤å¿ƒå¾—..."></textarea>
            <div class="modal-actions">
                <button id="modal-cancel-btn"></button>
                <button id="modal-save-btn"></button>
            </div>
        </div>
    </div>
    
    <!-- "æª¢è¦–æ—¥èªŒ"å½ˆå‡ºè¦–çª— (Modal) HTML -->
    <div class="modal-overlay" id="history-view-modal-overlay">
        <div class="modal">
            <h2 id="history-view-title"></h2>
            <div class="modal-image-preview" id="history-view-image"></div>
            <p id="history-view-text"></p>
            <div class="modal-actions">
                <button id="history-view-close-btn">é—œé–‰</button>
                <button id="history-view-edit-btn">ç·¨è¼¯æ—¥èªŒ</button>
            </div>
        </div>
    </div>

    <!-- é€šçŸ¥å½ˆå‡ºè¦–çª— HTML -->
    <div id="toast-notification">
        <div class="toast-content">
            <span id="toast-message"></span>
            <div class="toast-actions">
                <button id="toast-edit-btn">ç·¨è¼¯</button>
                <button id="toast-confirm-btn">ç¢ºèª</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // =====ã€æ‚¨çš„ Azure è³‡è¨Šã€‘=====
            const AZURE_VISION_KEY = '2eIQpQlLKEaHUo6oPEOZ1Rc4OAcfgxwSQ1IGLPLMYxWxNavbuNxGJQQJ99BGACqBBLyXJ3w3AAAAACOG6FFo';
            const AZURE_VISION_ENDPOINT = 'https://myhackathon-cv-service.services.ai.azure.com/';
            const AZURE_TRANSLATOR_KEY = '4kHZNgnsEFrUxfkSAEkflaDgEOF4dDk9NI2EjDq8k6kcnYeqHiY2JQQJ99BGACqBBLyXJ3w3AAAAACOGrcjp';
            const AZURE_TRANSLATOR_REGION = 'southeastasia';
            const AZURE_OPENAI_ENDPOINT = 'https://menu.openai.azure.com/';
            const AZURE_OPENAI_KEY = '6VpbFBGvvQkGXqnIqBu3AvoqYnqyenQUS2TIUzg2LyqVS5eMln9yJQQJ99BGACYeBjFXJ3w3AAABACOG1nCR';
            const AZURE_OPENAI_DEPLOYMENT_NAME = 'my-menu-gpt';

            // --- DOM å…ƒç´  ---
            const imageInput = document.getElementById('menu-image');
            const imagePreview = document.getElementById('image-preview');
            const processBtn = document.getElementById('process-btn');
            const resultsDiv = document.getElementById('results');
            const analysisResultsSection = document.getElementById('analysis-results-section');
            const customPrefInput = document.getElementById('custom-pref-input');
            const addPrefBtn = document.getElementById('add-pref-btn');
            const customPrefsDisplay = document.getElementById('custom-prefs-display');
            const languageSelector = document.getElementById('language-selector');
            const tabNav = document.querySelector('.tab-nav');
            const tabBtns = document.querySelectorAll('.tab-btn');
            const tabContents = document.querySelectorAll('.tab-content');
            const spinnerSection = document.getElementById('spinner-section');
            const wheel = document.getElementById('wheel');
            const spinBtn = document.getElementById('spin-btn');
            const spinnerResultText = document.getElementById('spinner-result-text');
            const spinActions = document.getElementById('spin-actions');
            const keepBtn = document.getElementById('keep-btn');
            const ctx = wheel.getContext('2d');
            const historyList = document.getElementById('history-list');
            const clearHistoryBtn = document.getElementById('clear-history-btn');
            
            // "ç·¨è¼¯"å½ˆå‡ºè¦–çª— DOM
            const modalOverlay = document.getElementById('log-modal-overlay');
            const modalTitle = document.getElementById('modal-title');
            const modalImagePreview = document.getElementById('modal-image-preview');
            const modalImageInput = document.getElementById('modal-image-input');
            const modalTextInput = document.getElementById('modal-text-input');
            const modalSaveBtn = document.getElementById('modal-save-btn');
            const modalCancelBtn = document.getElementById('modal-cancel-btn');

            // "æª¢è¦–"å½ˆå‡ºè¦–çª— DOM
            const historyViewModalOverlay = document.getElementById('history-view-modal-overlay');
            const historyViewTitle = document.getElementById('history-view-title');
            const historyViewImage = document.getElementById('history-view-image');
            const historyViewText = document.getElementById('history-view-text');
            const historyViewEditBtn = document.getElementById('history-view-edit-btn');
            const historyViewCloseBtn = document.getElementById('history-view-close-btn');

            // é€šçŸ¥èˆ‡ç…™ç« DOM
            const toastNotification = document.getElementById('toast-notification');
            const toastMessage = document.getElementById('toast-message');
            const toastEditBtn = document.getElementById('toast-edit-btn');
            const toastConfirmBtn = document.getElementById('toast-confirm-btn');
            const fireworksCanvas = document.getElementById('fireworks-canvas');
            const fireworksCtx = fireworksCanvas.getContext('2d');
            let fireworksParticles = [];

            // --- è®Šæ•¸ ---
            let customPreferences = [];
            let currentRotation = 0;
            let isSpinning = false;
            let isResultDisplayed = false; 
            let history = [];
            let editingIndex = null;
            let viewingIndex = null; // è¿½è¹¤æ­£åœ¨æª¢è¦–çš„é …ç›®ç´¢å¼•
            let currentLogEntry = {};
            let hoveredSliceIndex = null;
            let finalTranslationMap = {};
            let allAnalyzedDishes = [];
            let recommendedDishes = [];
            let spinnerOptions = [];
            const spinnerColors = ['#34495e', '#f39c12', '#e74c3c', '#3498db', '#2ecc71', '#9b59b6', '#1abc9c', '#e67e22', '#a0a0a0', '#c0392b', '#7f8c8d', '#d35400'];

            // --- å·¥å…·å‡½å¼ ---
            const updateStatus = (message, showLoader) => {
                let loaderHtml = showLoader ? '<div class="loader"></div>' : '';
                resultsDiv.innerHTML = `<div id="status-container">${loaderHtml}<div class="status-text">${message}</div></div>`;
                analysisResultsSection.style.display = 'block';
                spinnerSection.style.display = 'none';
            };

            const resizeImage = (file, maxWidth, maxHeight, quality) => new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let { width, height } = img;
                        if (width > height) {
                            if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        } else {
                            if (height > maxHeight) { width *= maxHeight / height; height = maxHeight; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        canvas.getContext('2d').drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
                reader.onerror = error => reject(error);
            });
            
            // --- ç…™ç«èˆ‡é€šçŸ¥é‚è¼¯ ---
            function createFireworks() {
                const particleCount = 150;
                const colors = ["#f0c419", "#ffec8a", "#e74c3c", "#3498db", "#2ecc71", "#ffffff"];
                const toastRect = toastNotification.getBoundingClientRect();
                fireworksCanvas.width = window.innerWidth;
                fireworksCanvas.height = window.innerHeight;
                
                const startX = toastRect.left + toastRect.width / 2;
                const startY = toastRect.top + toastRect.height / 2;

                fireworksParticles = [];
                for (let i = 0; i < particleCount; i++) {
                    fireworksParticles.push({
                        x: startX,
                        y: startY,
                        radius: Math.random() * 3 + 1,
                        color: colors[Math.floor(Math.random() * colors.length)],
                        vx: Math.random() * 12 - 6,
                        vy: Math.random() * -18 - 6,
                        opacity: 1,
                        gravity: 0.3,
                    });
                }
            }
            
            function animateFireworks() {
                fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
                let activeParticles = false;
                fireworksParticles.forEach(p => {
                    if(p.opacity > 0) {
                        activeParticles = true;
                        p.vy += p.gravity;
                        p.x += p.vx;
                        p.y += p.vy;
                        p.opacity -= 0.015;
            
                        fireworksCtx.globalAlpha = p.opacity;
                        fireworksCtx.fillStyle = p.color;
                        fireworksCtx.beginPath();
                        fireworksCtx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                        fireworksCtx.fill();
                    }
                });
                if(activeParticles) {
                    requestAnimationFrame(animateFireworks);
                } else {
                    fireworksCtx.clearRect(0, 0, fireworksCanvas.width, fireworksCanvas.height);
                }
            }

            const hideToast = () => toastNotification.classList.remove('show');
            
            const showSaveToast = (savedIndex, savedText, isEditing) => {
                toastMessage.textContent = `ã€Œ${savedText}ã€${isEditing ? 'å·²æ›´æ–°' : 'å·²å„²å­˜è‡³æ—¥èªŒ'}ï¼`;
                toastNotification.classList.add('show');
                
                createFireworks();
                requestAnimationFrame(animateFireworks);
                
                toastEditBtn.onclick = () => {
                    hideToast();
                    showLogModal({ index: savedIndex, entry: history[savedIndex], title: `ç·¨è¼¯æ—¥èªŒ - ${history[savedIndex].text}`, saveText: 'å„²å­˜è®Šæ›´', cancelText: 'å–æ¶ˆ' });
                };

                toastConfirmBtn.onclick = hideToast;
                setTimeout(hideToast, 6000); // 6ç§’å¾Œè‡ªå‹•é—œé–‰
            };

            // --- AI èˆ‡éæ¿¾é‚è¼¯ (æœªè®Šæ›´) ---
            async function getOcrText(imageSource) {
                updateStatus('æ­£åœ¨å°‡åœ–ç‰‡ä¸Šå‚³è‡³ Azure AI Vision (v3.2) é€²è¡Œåˆ†æ...', true);
                const cleanEndpoint = AZURE_VISION_ENDPOINT.replace(/\/+$/, "");
                const analyzeUrl = `${cleanEndpoint}/vision/v3.2/read/analyze`;
                let imageBody;
                if (typeof imageSource === 'string') {
                    const imageResponse = await fetch(imageSource);
                    imageBody = await imageResponse.blob();
                } else { imageBody = imageSource; }
                const response = await fetch(analyzeUrl, { method: 'POST', headers: { 'Content-Type': 'application/octet-stream', 'Ocp-Apim-Subscription-Key': AZURE_VISION_KEY }, body: imageBody });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`Azure API éŒ¯èª¤ (æäº¤éšæ®µ): ${errorData.error.message}`); }
                const operationLocation = response.headers.get('Operation-Location');
                if (!operationLocation) throw new Error('ç„¡æ³•å¾ Azure å›æ‡‰ä¸­ç²å–æ“ä½œä½ç½®ã€‚');
                let result;
                while (true) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    updateStatus('æ­£åœ¨å¾ Azure ç²å–è¾¨è­˜çµæœ...', true);
                    const resultResponse = await fetch(operationLocation, { headers: { 'Ocp-Apim-Subscription-Key': AZURE_VISION_KEY } });
                    result = await resultResponse.json();
                    if (result.status === 'succeeded') return result.analyzeResult.readResults.flatMap(page => page.lines.map(line => line.text)).join('\n');
                    if (result.status === 'failed') throw new Error(`Azure OCR è™•ç†å¤±æ•—: ${result.error?.message || 'æœªçŸ¥éŒ¯èª¤'}`);
                }
            }
            async function filterDishesWithAzureAI(rawText) {
                const apiEndpoint = `${AZURE_OPENAI_ENDPOINT}/openai/deployments/${AZURE_OPENAI_DEPLOYMENT_NAME}/chat/completions?api-version=2023-07-01-preview`;
                const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„èœå–®åˆ†æå¸«ã€‚æˆ‘æœƒæä¾›å¾èœå–®åœ–ç‰‡ OCR è¾¨è­˜å‡ºçš„æ–‡å­—ã€‚ä½ çš„ä»»å‹™æ˜¯ï¼š
1. åªæ‰¾å‡ºä»£è¡¨ã€Œèœå“åç¨±ã€æˆ–ã€Œé£²æ–™åç¨±ã€çš„é …ç›®ã€‚
2. å¿½ç•¥æ‰€æœ‰åˆ†é¡æ¨™é¡Œï¼ˆå¦‚ "ä¸»é£Ÿ", "é£²æ–™", "Appetizers"ï¼‰ã€åƒ¹æ ¼ã€åœ°å€ã€é›»è©±ã€æè¿°æ€§æ–‡å­—æˆ–ä»»ä½•éèœå“é …ç›®ã€‚
3. å°‡çµæœä»¥ä¸€å€‹ JSON é™£åˆ—çš„å½¢å¼å›å‚³ï¼Œé™£åˆ—ä¸­æ¯å€‹å…ƒç´ éƒ½æ˜¯ä¸€å€‹èœå“åç¨±å­—ä¸²ã€‚ä¾‹å¦‚: ["éº»å©†è±†è…", "è±šéª¨æ‹‰éºµ", "å¯å£å¯æ¨‚"]ã€‚
4. å¦‚æœæ‰¾ä¸åˆ°ä»»ä½•èœå“ï¼Œè«‹å›å‚³ä¸€å€‹ç©ºçš„ JSON é™£åˆ— []ã€‚
5. ä½ çš„å›å‚³å¿…é ˆæ˜¯åš´æ ¼çš„ JSON æ ¼å¼ï¼Œä¸”æ ¹ç‰©ä»¶è¦æœ‰ä¸€å€‹ key å«åš "dishes"ï¼Œå…¶ value æ˜¯èœå“åç¨±é™£åˆ—ã€‚ç¯„ä¾‹ï¼š { "dishes": ["èœå“A", "èœå“B"] }`;
                const userPrompt = `é€™æ˜¯å¾èœå–®è¾¨è­˜å‡ºçš„æ–‡å­—ï¼Œè«‹å¹«æˆ‘æ‰¾å‡ºæ‰€æœ‰èœå“å’Œé£²æ–™åç¨±ï¼š\n\n${rawText}`;
                const body = { messages: [ { role: "system", content: systemPrompt }, { role: "user", content: userPrompt } ] };
                const response = await fetch(apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', 'api-key': AZURE_OPENAI_KEY }, body: JSON.stringify(body) });
                if (!response.ok) { throw new Error(`Azure OpenAI (èœå“è¾¨è­˜) API éŒ¯èª¤: ${response.statusText}`); }
                const data = await response.json();
                try {
                    const content = JSON.parse(data.choices[0].message.content);
                    const dishes = content.dishes || [];
                    if (!Array.isArray(dishes)) throw new Error("AI å›å‚³çš„æ ¼å¼ä¸æ˜¯æœ‰æ•ˆçš„é™£åˆ—ã€‚");
                    return dishes;
                } catch (e) { console.error("è§£æ AI å›æ‡‰æ™‚å‡ºéŒ¯ (èœå“è¾¨è­˜):", data.choices[0].message.content); throw new Error("ç„¡æ³•è§£æ AI å›å‚³çš„èœå“åˆ—è¡¨ã€‚"); }
            }
            async function analyzeIngredientsWithAzureAI(dishes, customPrefs) {
                const apiEndpoint = `${AZURE_OPENAI_ENDPOINT}/openai/deployments/${AZURE_OPENAI_DEPLOYMENT_NAME}/chat/completions?api-version=2023-07-01-preview`;
                const systemPrompt = `ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é£Ÿå“ç§‘å­¸å®¶å’Œå»šå¸«ã€‚ä½ çš„ä»»å‹™æ˜¯åˆ†æèœå“ï¼Œä¸¦æ ¹æ“šä½¿ç”¨è€…çš„è‡ªè¨‚åå¥½é€²è¡Œèªæ„åˆ¤æ–·ã€‚
**ä½ çš„å›å‚³å¿…é ˆæ˜¯åš´æ ¼çš„ JSON æ ¼å¼ï¼ŒåŒ…å«ä»¥ä¸‹æ¬„ä½ï¼š**
1.  \`name\`: (string) èœå“çš„åŸå§‹åç¨±ã€‚
2.  \`englishName\`: (string) é€™é“èœæœ€æ¨™æº–çš„**è‹±æ–‡ç¿»è­¯åç¨±**ã€‚
3.  \`mainIngredients\`: (string array) é€™é“èœæœ€å¸¸è¦‹çš„**è‹±æ–‡**ä¸»è¦é£Ÿæåˆ—è¡¨ã€‚
4.  \`allergens\`: (string array) å¾é€™å€‹å›ºå®šåˆ—è¡¨ä¸­é¸æ“‡å¯èƒ½çš„éæ•åŸï¼šPork, Beef, Chicken, Fish, Seafood, Lamb, Nuts, Peanuts, Alcohol, Spicy, Dairy, Gluten, Eggsã€‚
5.  \`customFilterMatch\`: (string or null) æª¢æŸ¥èœå“æ˜¯å¦ç¬¦åˆä½¿ç”¨è€…çš„è‡ªè¨‚åå¥½ã€‚å¦‚æœç¬¦åˆï¼Œæ­¤æ¬„ä½æ‡‰ç‚º**è§£é‡‹åŸå› çš„è‹±æ–‡**ï¼ˆä¾‹å¦‚ï¼š"Contains chicken thigh, matching the 'chicken' filter"ï¼‰ï¼›å¦‚æœä¸ç¬¦åˆï¼Œæ­¤æ¬„ä½å¿…é ˆç‚º \`null\`ã€‚
**èªæ„åˆ¤æ–·è¦å‰‡ï¼š**
- ä½ å¿…é ˆã€Œèˆ‰ä¸€åä¸‰ã€ã€‚å¦‚æœä½¿ç”¨è€…çš„åå¥½æ˜¯ã€Œé›è‚‰ (chicken)ã€ï¼Œé‚£éº¼èœå“ä¸­çš„ã€Œé›è…¿ã€æˆ–ã€Œé›ç¿…ã€éƒ½ç®—ç¬¦åˆã€‚
- å¦‚æœä½¿ç”¨è€…çš„åå¥½æ˜¯ã€Œç‰›è‚‰ (beef)ã€ï¼Œé‚£éº¼ã€Œç‰›æ’ã€ã€ã€Œç‰›è…©ã€æˆ–ã€Œç‰›å°¾ã€éƒ½ç®—ç¬¦åˆã€‚
- å¦‚æœä½¿ç”¨è€…çš„è‡ªè¨‚åå¥½åˆ—è¡¨ç‚ºç©ºï¼Œå‰‡ \`customFilterMatch\` æ°¸é ç‚º \`null\`ã€‚`;
                const analysisPromises = dishes.map(dishName => {
                    const userPrompt = `ä½¿ç”¨è€…çš„è‡ªè¨‚æ’é™¤é …ç›®æ˜¯ï¼š[${customPrefs.join(', ')}]\n\nç¾åœ¨ï¼Œè«‹åˆ†æé€™é“èœå“: "${dishName}"`;
                    const body = { messages: [ { role: "system", content: systemPrompt }, { role: "user", content: userPrompt } ] };
                    return fetch(apiEndpoint, { method: 'POST', headers: { 'Content-Type': 'application/json', 'api-key': AZURE_OPENAI_KEY }, body: JSON.stringify(body) })
                        .then(response => response.ok ? response.json() : { error: true })
                        .then(data => {
                            if (data.error) return { name: dishName, error: true, englishName: dishName, mainIngredients: [], allergens: [], customFilterMatch: null };
                            try {
                                const parsedContent = JSON.parse(data.choices[0].message.content);
                                return { name: parsedContent.name || dishName, englishName: parsedContent.englishName || dishName, mainIngredients: parsedContent.mainIngredients || [], allergens: parsedContent.allergens || [], customFilterMatch: parsedContent.customFilterMatch || null, error: false };
                            } catch (e) { return { name: dishName, error: true, englishName: dishName, mainIngredients: ["Analysis failed"], allergens: [], customFilterMatch: null }; }
                        }).catch(err => ({ name: dishName, error: true, englishName: dishName, mainIngredients: ["Network error"], allergens: [], customFilterMatch: null }));
                });
                return Promise.all(analysisPromises);
            }
            async function translateText(textArray, sourceLang, targetLang) {
                const endpoint = "https://api.cognitive.microsofttranslator.com";
                const url = `${endpoint}/translate?api-version=3.0&from=${sourceLang}&to=${targetLang}`;
                const textsToTranslate = [...textArray, 'ğŸ‘ Recommended Dishes', 'ğŸ‘ Filtered Dishes', 'No recommended dishes found matching all your preferences.', "Great! All dishes seem to match your preferences.", 'Contains meat', 'Contains pork', 'Contains nuts', 'Contains alcohol', 'Spicy', 'Analysis failed'];
                const uniqueTexts = Array.from(new Set(textsToTranslate.filter(t => t && typeof t === 'string' && t.trim() !== '')));
                const body = uniqueTexts.map(text => ({ 'text': text }));
                if (body.length === 0) return {};
                const response = await fetch(url, { method: 'POST', headers: { 'Ocp-Apim-Subscription-Key': AZURE_TRANSLATOR_KEY, 'Ocp-Apim-Subscription-Region': AZURE_TRANSLATOR_REGION, 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
                if (!response.ok) { const errorData = await response.json(); throw new Error(`Azure Translator API éŒ¯èª¤: ${errorData.error.message}`); }
                const data = await response.json();
                const translationMap = {};
                for (let i = 0; i < uniqueTexts.length; i++) { translationMap[uniqueTexts[i]] = data[i].translations[0].text; }
                return translationMap;
            }
            function getFilterReasons(analyzedDish) {
                const isVegetarian = document.getElementById('pref-vegetarian').checked, noPork = document.getElementById('pref-no-pork').checked, noNuts = document.getElementById('pref-no-nuts').checked, noAlcohol = document.getElementById('pref-no-alcohol').checked, noSpicy = document.getElementById('pref-no-spicy').checked;
                if(analyzedDish.error) return "Analysis failed";
                const lowerCaseAllergens = (analyzedDish.allergens || []).map(a => a.toLowerCase());
                let reason = '';
                if (isVegetarian && lowerCaseAllergens.some(a => ['pork', 'beef', 'chicken', 'lamb', 'fish', 'seafood'].includes(a))) reason = 'Contains meat';
                else if (noPork && lowerCaseAllergens.includes('pork')) reason = 'Contains pork';
                else if (noNuts && (lowerCaseAllergens.includes('nuts') || lowerCaseAllergens.includes('peanuts'))) reason = 'Contains nuts';
                else if (noAlcohol && lowerCaseAllergens.includes('alcohol')) reason = 'Contains alcohol';
                else if (noSpicy && lowerCaseAllergens.includes('spicy')) reason = 'Spicy';
                else if (analyzedDish.customFilterMatch) reason = analyzedDish.customFilterMatch;
                return reason;
            }
            function generateFinalHtml(dishesWithReasons, translationMap) {
                let recommendedList = '', filteredList = '', recommendedCount = 0, filteredCount = 0;
                dishesWithReasons.forEach(dish => {
                    const translatedName = translationMap[dish.englishName] || dish.englishName;
                    const originalNameHtml = (translatedName.toLowerCase() !== dish.name.toLowerCase()) ? `<span class="original-text">${dish.name}</span>` : '';
                    const ingredientsHtml = `<span class="original-text">${dish.error ? (translationMap["Analysis failed"] || "åˆ†æå¤±æ•—") : (translationMap[dish.mainIngredients.join(', ')] || dish.mainIngredients.join(', '))}</span>`;
                    if (dish.filterReason) {
                        filteredCount++;
                        const reasonHtml = `<span class="reason-tag">âš ï¸ ${translationMap[dish.filterReason] || dish.filterReason}</span>`;
                        filteredList += `<li><div class="dish-translation"><span class="filtered-out">${translatedName}</span>${originalNameHtml}${ingredientsHtml}${reasonHtml}</div></li>`;
                    } else {
                        recommendedCount++;
                        recommendedList += `<li><div class="dish-translation"><span class="highlight">${translatedName}</span>${originalNameHtml}${ingredientsHtml}</div></li>`;
                    }
                });
                const tRecommended = translationMap['ğŸ‘ Recommended Dishes'] || 'ğŸ‘ æ¨è–¦èœè‰²';
                const tFiltered = translationMap['ğŸ‘ Filtered Dishes'] || 'ğŸ‘ å·²éæ¿¾èœè‰²';
                const tNoRec = translationMap['No recommended dishes found matching all your preferences.'] || 'æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ‚¨æ‰€æœ‰åå¥½çš„æ¨è–¦èœè‰²ã€‚';
                const tAllMatch = translationMap["Great! All dishes seem to match your preferences."] || 'å¤ªæ£’äº†ï¼æ‰€æœ‰èœè‰²ä¼¼ä¹éƒ½ç¬¦åˆæ‚¨çš„åå¥½ã€‚';
                let finalHtml = `<div class="result-section"><h4>${tRecommended} (${recommendedCount})</h4><ul>${recommendedList || `<li>${tNoRec}</li>`}</ul></div>`;
                finalHtml += `<div class="result-section"><h4>${tFiltered} (${filteredCount})</h4><ul>${filteredList || `<li>${tAllMatch}</li>`}</ul></div>`;
                return finalHtml;
            }

            // --- è½‰ç›¤é‚è¼¯ (æœªè®Šæ›´) ---
            const drawWheel = () => {
                const numOptions = spinnerOptions.length;
                const centerX = wheel.width / 2;
                const centerY = wheel.height / 2;
                const baseRadius = wheel.width / 2 - 10;
                ctx.clearRect(0, 0, wheel.width, wheel.height);
                if (numOptions === 0) {
                    spinBtn.disabled = true;
                    spinnerResultText.textContent = analysisResultsSection.style.display !== 'none' ? 'æ²’æœ‰æ¨è–¦èœè‰²å¯ä¾›é¸æ“‡ã€‚' : 'è«‹å…ˆåˆ†æèœå–®ä»¥è¼‰å…¥é¸é …ã€‚';
                    spinActions.style.display = 'none';
                    return;
                }
                if (!isSpinning) { spinBtn.disabled = false; }
                const arcSize = 2 * Math.PI / numOptions;
                spinnerOptions.forEach((option, i) => {
                    const isHighlighted = (i === hoveredSliceIndex);
                    const radius = isHighlighted ? baseRadius + 5 : baseRadius;
                    const angle = i * arcSize - Math.PI / 2;
                    ctx.save();
                    ctx.fillStyle = spinnerColors[i % spinnerColors.length];
                    if (isHighlighted) { ctx.shadowColor = '#f0c419'; ctx.shadowBlur = 20; }
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, angle, angle + arcSize);
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                    ctx.save();
                    ctx.strokeStyle = '#fff';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(centerX, centerY);
                    ctx.arc(centerX, centerY, radius, angle, angle + arcSize);
                    ctx.closePath();
                    ctx.stroke();
                    ctx.restore();
                    if (isHighlighted) {
                        ctx.save();
                        ctx.fillStyle = '#fff';
                        ctx.font = `bold 16px ${getComputedStyle(document.body).fontFamily.split(',')[0]}, sans-serif`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        const textAngle = angle + arcSize / 2;
                        ctx.translate(centerX + Math.cos(textAngle) * radius * 0.65, centerY + Math.sin(textAngle) * radius * 0.65);
                        ctx.rotate(textAngle + Math.PI / 2);
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.7)';
                        ctx.shadowBlur = 5;
                        const maxWidth = radius * 1.1;
                        ctx.fillText(option, 0, 0, maxWidth);
                        ctx.restore();
                    }
                });
             };
            const spin = () => {
                if (isSpinning || spinnerOptions.length === 0) return;
                isSpinning = true;
                isResultDisplayed = false;
                spinBtn.disabled = true;
                spinnerResultText.textContent = 'è½‰å•Šè½‰...';
                spinActions.style.display = 'none';
                hoveredSliceIndex = null;
                drawWheel(); 
                const randomSpins = Math.floor(Math.random() * 5) + 5;
                const randomStopAngle = Math.random() * 360;
                const totalRotation = randomSpins * 360 + randomStopAngle;
                const newRotation = currentRotation + totalRotation;
                wheel.style.transition = 'transform 5s cubic-bezier(0.1, 0.7, 0.3, 1)';
                wheel.style.transform = `rotate(${newRotation}deg)`;
                currentRotation = newRotation;
                setTimeout(() => {
                    isSpinning = false;
                    isResultDisplayed = true; 
                    spinBtn.disabled = false;
                    spinBtn.textContent = 'å†è½‰ä¸€æ¬¡';
                    const finalAngle = currentRotation % 360;
                    const winnerIndex = Math.floor(((360 - finalAngle) % 360) / (360 / spinnerOptions.length));
                    const winnerDishName = spinnerOptions[winnerIndex];
                    if (winnerDishName) {
                        spinnerResultText.textContent = `æ­å–œï¼ä»Šå¤©çš„é¸æ“‡æ˜¯ï¼š${winnerDishName}`;
                        const dishFullDetails = recommendedDishes.find(d => (languageSelector.value === 'en' ? d.englishName : (finalTranslationMap[d.englishName] || d.englishName)) === winnerDishName);
                        currentLogEntry = { text: winnerDishName, fullDetails: dishFullDetails };
                        spinActions.style.display = 'block';
                    } else {
                        spinnerResultText.textContent = 'å‡ºéŒ¯äº†ï¼Œè«‹åˆ·æ–°é é¢ï¼';
                        spinActions.style.display = 'none';
                    }
                }, 5000);
            };
            function handleMouseMove(e) {
                if (isSpinning || isResultDisplayed) return;
                const rect = wheel.getBoundingClientRect(), scaleX = wheel.width / rect.width, scaleY = wheel.height / rect.height, mouseX = (e.clientX - rect.left) * scaleX, mouseY = (e.clientY - rect.top) * scaleY;
                const dx = mouseX - wheel.width / 2, dy = mouseY - wheel.height / 2, distance = Math.sqrt(dx * dx + dy * dy);
                const oldHoveredIndex = hoveredSliceIndex;
                let newHoveredIndex = null;
                if (distance <= (wheel.width / 2 - 10) + 5 && spinnerOptions.length > 0) {
                    let normalizedAngle = (Math.atan2(dy, dx) - (currentRotation % 360) * Math.PI / 180 + (2.5 * Math.PI)) % (2 * Math.PI);
                    newHoveredIndex = Math.floor(normalizedAngle / (2 * Math.PI / spinnerOptions.length));
                }
                if (newHoveredIndex !== oldHoveredIndex) {
                    hoveredSliceIndex = newHoveredIndex;
                    drawWheel();
                    spinnerResultText.textContent = newHoveredIndex !== null ? 'é»æ“ŠæŒ‰éˆ•ä¾†æ±ºå®šä½ çš„ä¸‹ä¸€é¤ï¼' : 'å°‡æ»‘é¼ ç§»åˆ°è½‰ç›¤ä¸Šçœ‹çœ‹æœ‰ä»€éº¼å¥½æ–™ï¼';
                }
            }
            function handleMouseLeave() {
                if (isSpinning || isResultDisplayed || hoveredSliceIndex === null) return;
                hoveredSliceIndex = null;
                drawWheel();
                spinnerResultText.textContent = 'å°‡æ»‘é¼ ç§»åˆ°è½‰ç›¤ä¸Šçœ‹çœ‹æœ‰ä»€éº¼å¥½æ–™ï¼';
            }

            // --- ç¾é£Ÿæ—¥èªŒé‚è¼¯ ---
            const formatTimestamp = (ts) => new Date(ts).toLocaleString('zh-TW', { dateStyle: 'short', timeStyle: 'short' });
            const renderHistory = () => {
                if (history.length === 0) {
                    historyList.innerHTML = `<p style="color: var(--text-secondary-color);">ç›®å‰æ²’æœ‰ä»»ä½•ç¾é£Ÿç´€éŒ„å–”ï¼</p>`;
                    clearHistoryBtn.style.display = 'none';
                } else {
                    clearHistoryBtn.style.display = 'inline-block';
                    historyList.innerHTML = '';
                    history.slice().reverse().forEach((entry, revIndex) => {
                        const originalIndex = history.length - 1 - revIndex;
                        const li = document.createElement('li');
                        li.dataset.index = originalIndex; // è¨­å®šç´¢å¼•ä»¥åˆ©é»æ“Šè™•ç†
                        const imgHTML = entry.image ? `<img src="${entry.image}" class="history-img" alt="${entry.text}">` : `<div class="history-img">ç„¡åœ–ç‰‡</div>`;
                        const noteHTML = entry.note ? `<p class="truncated-note">${entry.note}</p>` : `<p class="truncated-note" style="color: var(--text-secondary-color);"><i>ç„¡å¿ƒå¾—ç­†è¨˜</i></p>`;
                        li.innerHTML = `
                            ${imgHTML}
                            <div class="history-details">
                                <div class="history-header"><h4>${entry.text}</h4></div>
                                ${noteHTML}
                                <span class="timestamp">${formatTimestamp(entry.timestamp)}</span>
                            </div>
                            <div class="history-actions"><button class="delete-btn" title="åˆªé™¤">ğŸ—‘ï¸</button></div>
                        `;
                        // ç›£è½æ•´å€‹å¡ç‰‡çš„é»æ“Šäº‹ä»¶ (åˆªé™¤æŒ‰éˆ•é™¤å¤–)
                        li.addEventListener('click', (e) => {
                            if (!e.target.closest('.delete-btn')) {
                                showHistoryViewModal(originalIndex);
                            }
                        });
                        // å–®ç¨ç›£è½åˆªé™¤æŒ‰éˆ•
                        li.querySelector('.delete-btn').addEventListener('click', () => deleteHistoryEntry(originalIndex));
                        historyList.appendChild(li);
                    });
                }
            };
            const saveHistory = (entry) => {
                if (editingIndex !== null) {
                    history[editingIndex] = { ...history[editingIndex], ...entry };
                } else {
                    entry.timestamp = Date.now();
                    history.push(entry);
                }
                localStorage.setItem('foodWheelHistory', JSON.stringify(history));
                renderHistory();
            };
            const deleteHistoryEntry = (index) => {
                if (confirm(`ç¢ºå®šè¦åˆªé™¤é€™ç­†ã€Œ${history[index].text}ã€çš„æ—¥èªŒå—ï¼Ÿ`)) {
                    history.splice(index, 1);
                    localStorage.setItem('foodWheelHistory', JSON.stringify(history));
                    renderHistory();
                }
            };
            const loadHistory = () => {
                const savedHistory = localStorage.getItem('foodWheelHistory');
                if (savedHistory) history = JSON.parse(savedHistory);
                renderHistory();
            };
            const clearHistory = () => {
                if (history.length > 0 && confirm('ç¢ºå®šè¦æ¸…é™¤ã€æ‰€æœ‰ã€‘ç¾é£Ÿæ—¥èªŒç´€éŒ„å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸã€‚')) {
                    history = [];
                    localStorage.removeItem('foodWheelHistory');
                    renderHistory();
                }
            };

            // --- å½ˆå‡ºè¦–çª— (ç·¨è¼¯èˆ‡æª¢è¦–) ---
            const showLogModal = (config) => { // "ç·¨è¼¯"å½ˆå‡ºè¦–çª—
                editingIndex = typeof config.index === 'number' ? config.index : null;
                currentLogEntry = { ...config.entry };
                modalTitle.textContent = config.title;
                modalImagePreview.innerHTML = currentLogEntry.image ? `<img src="${currentLogEntry.image}" alt="é è¦½">` : '<span>åœ–ç‰‡é è¦½å€</span>';
                modalTextInput.value = currentLogEntry.note || '';
                modalImageInput.value = '';
                modalSaveBtn.textContent = config.saveText;
                modalCancelBtn.textContent = config.cancelText;
                modalOverlay.style.display = 'flex';
            };
            const hideLogModal = () => modalOverlay.style.display = 'none';

            const showHistoryViewModal = (index) => { // "æª¢è¦–"å½ˆå‡ºè¦–çª—
                viewingIndex = index;
                const entry = history[index];
                historyViewTitle.textContent = entry.text;
                historyViewImage.innerHTML = entry.image ? `<img src="${entry.image}" alt="${entry.text}">` : '<span>ç„¡ç…§ç‰‡</span>';
                historyViewText.textContent = entry.note || 'æ²’æœ‰ç•™ä¸‹ä»»ä½•å¿ƒå¾—ç­†è¨˜ã€‚';
                historyViewModalOverlay.style.display = 'flex';
            };
            const hideHistoryViewModal = () => historyViewModalOverlay.style.display = 'none';

            const handleImageUpload = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                try {
                    currentLogEntry.image = await resizeImage(file, 800, 800, 0.8);
                    modalImagePreview.innerHTML = `<img src="${currentLogEntry.image}" alt="é è¦½">`;
                } catch (error) { console.error("åœ–ç‰‡è™•ç†å¤±æ•—:", error); alert("åœ–ç‰‡è™•ç†å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚"); }
            };
            const handleSaveLog = () => {
                currentLogEntry.note = modalTextInput.value.trim();
                const isEditing = editingIndex !== null;
                const savedIndex = isEditing ? editingIndex : history.length;
                const savedText = currentLogEntry.text;
                saveHistory(currentLogEntry);
                hideLogModal();
                showSaveToast(savedIndex, savedText, isEditing);
            };

            // --- è‡ªè¨‚åå¥½ ---
            function renderCustomPrefs() {
                customPrefsDisplay.innerHTML = '';
                customPreferences.forEach((pref, index) => {
                    const tag = document.createElement('span'); tag.className = 'custom-tag'; tag.textContent = pref;
                    const deleteBtn = document.createElement('button'); deleteBtn.className = 'delete-tag-btn'; deleteBtn.textContent = 'x';
                    deleteBtn.onclick = () => { customPreferences.splice(index, 1); renderCustomPrefs(); savePrefsToLocalStorage(); };
                    tag.appendChild(deleteBtn); customPrefsDisplay.appendChild(tag);
                });
            }
            function savePrefsToLocalStorage() { localStorage.setItem('myMenuAppCustomPrefs', JSON.stringify(customPreferences)); }
            function loadPrefsFromLocalStorage() { const savedPrefs = localStorage.getItem('myMenuAppCustomPrefs'); if (savedPrefs) { customPreferences = JSON.parse(savedPrefs); renderCustomPrefs(); } }

            // --- ä¸»è¦æµç¨‹ ---
            processBtn.addEventListener('click', async () => {
                let imageSource = (imageInput.files && imageInput.files.length > 0) ? imageInput.files[0] : imagePreview.src;
                if (!imageSource) { alert('æ²’æœ‰æ‰¾åˆ°å¯åˆ†æçš„åœ–ç‰‡ï¼'); return; }
                processBtn.disabled = true;
                spinBtn.textContent = 'é–‹å§‹æ—‹è½‰ï¼';
                spinBtn.disabled = true;
                spinActions.style.display = 'none';
                isResultDisplayed = false; 
                analysisResultsSection.style.display = 'block';
                try {
                    const ocrText = await getOcrText(imageSource);
                    if (!ocrText) { updateStatus('éŒ¯èª¤ï¼šç„¡æ³•å¾åœ–ç‰‡ä¸­è¾¨è­˜æ–‡å­—ã€‚', false); return; }
                    updateStatus('OCR è¾¨è­˜å®Œæˆï¼Œæ­£åœ¨è«‹ AI è¾¨è­˜èœå“åç¨±...', true);
                    const originalDishes = await filterDishesWithAzureAI(ocrText);
                    if (originalDishes.length === 0) { updateStatus('AI åœ¨åœ–ç‰‡ä¸­æ²’æœ‰æ‰¾åˆ°å¯è¾¨è­˜çš„èœå“é …ç›®ã€‚', false); spinnerSection.style.display = 'none'; return; }
                    updateStatus(`èœå“è¾¨è­˜å®Œæˆ (${originalDishes.length}é …)ï¼Œæ­£åœ¨ç‚ºæ¯å€‹èœå“é€²è¡Œæ™ºæ…§åˆ†æ...`, true);
                    allAnalyzedDishes = await analyzeIngredientsWithAzureAI(originalDishes, customPreferences);
                    recommendedDishes = allAnalyzedDishes.filter(dish => !getFilterReasons(dish));
                    const dishesWithReasons = allAnalyzedDishes.map(d => ({ ...d, filterReason: getFilterReasons(d) }));
                    const allTextsToTranslate = new Set(allAnalyzedDishes.flatMap(d => [d.englishName, d.mainIngredients.join(', '), getFilterReasons(d)]));
                    finalTranslationMap = await translateText(Array.from(allTextsToTranslate), 'en', languageSelector.value);
                    resultsDiv.innerHTML = generateFinalHtml(dishesWithReasons, finalTranslationMap);
                    spinnerOptions = recommendedDishes.map(dish => languageSelector.value === 'en' ? dish.englishName : (finalTranslationMap[dish.englishName] || dish.englishName));
                    spinnerSection.style.display = 'block';
                    spinnerResultText.textContent = spinnerOptions.length > 0 ? 'å°‡æ»‘é¼ ç§»åˆ°è½‰ç›¤ä¸Šçœ‹çœ‹æœ‰ä»€éº¼å¥½æ–™ï¼' : 'æ²’æœ‰æ¨è–¦èœè‰²å¯ä¾›é¸æ“‡ã€‚';
                    drawWheel();
                } catch (error) {
                    console.error('ç™¼ç”ŸéŒ¯èª¤:', error);
                    updateStatus(`ç™¼ç”ŸéŒ¯èª¤: ${error.message}`, false);
                    spinnerSection.style.display = 'none';
                } finally {
                    processBtn.disabled = false;
                }
            });

            // --- äº‹ä»¶ç›£è½ ---
            tabNav.addEventListener('click', (e) => {
                if (e.target.matches('.tab-btn')) {
                    const targetTab = e.target.dataset.tab;
                    tabBtns.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    e.target.classList.add('active');
                    document.getElementById(`tab-content-${targetTab}`).classList.add('active');
                }
            });
            imageInput.addEventListener('change', (event) => {
                const file = event.target.files[0]; if (file) { const reader = new FileReader(); reader.onload = (e) => { imagePreview.src = e.target.result; }; reader.readAsDataURL(file); }
            });
            addPrefBtn.addEventListener('click', () => {
                const newPref = customPrefInput.value.trim(); if (newPref && !customPreferences.includes(newPref)) { customPreferences.push(newPref); customPrefInput.value = ''; renderCustomPrefs(); savePrefsToLocalStorage(); }
            });
            customPrefInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') addPrefBtn.click(); });
            spinBtn.addEventListener('click', spin);
            keepBtn.addEventListener('click', () => {
                spinBtn.disabled = true; isResultDisplayed = false;
                showLogModal({ entry: currentLogEntry, title: `è¨˜éŒ„ç¾é£Ÿ - ${currentLogEntry.text}`, saveText: 'å„²å­˜æ—¥èªŒ', cancelText: 'ç•¥é' });
                spinActions.style.display = 'none'; spinnerResultText.textContent = `å¤ªæ£’äº†ï¼å°±æ±ºå®šåƒã€Œ${currentLogEntry.text}ã€`;
            });
            clearHistoryBtn.addEventListener('click', clearHistory);
            
            modalImageInput.addEventListener('change', handleImageUpload);
            modalSaveBtn.addEventListener('click', handleSaveLog);
            modalCancelBtn.addEventListener('click', hideLogModal);
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) hideLogModal(); });
            
            historyViewCloseBtn.addEventListener('click', hideHistoryViewModal);
            historyViewEditBtn.addEventListener('click', () => {
                hideHistoryViewModal();
                showLogModal({ index: viewingIndex, entry: history[viewingIndex], title: `ç·¨è¼¯æ—¥èªŒ - ${history[viewingIndex].text}`, saveText: 'å„²å­˜è®Šæ›´', cancelText: 'å–æ¶ˆ' });
            });
            historyViewModalOverlay.addEventListener('click', (e) => { if (e.target === historyViewModalOverlay) hideHistoryViewModal(); });
            
            wheel.addEventListener('mousemove', handleMouseMove);
            wheel.addEventListener('mouseleave', handleMouseLeave);

            // --- åˆå§‹è¼‰å…¥ ---
            loadPrefsFromLocalStorage();
            loadHistory();
            drawWheel();
        });
    </script>
</body>
</html>